name: Deploy Frontend to EC2

on:
  push:
    branches: [ "main" ]
    paths:
      - 'frontend/**' # frontend 폴더가 바뀔 때만 실행

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # 1. GitHub Container Registry 로그인 (별도 비밀번호 설정 불필요)
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # 2. Docker 이미지 빌드 및 푸시
    - name: Build and Push Docker Image
      run: |
        cd frontend
        # 이미지 태그를 소문자로 설정 (ghcr.io는 대문자 허용 안함)
        IMAGE_ID=ghcr.io/team-lms-2026-1/lms-frontend
        
        docker build -t $IMAGE_ID:latest \
          -t $IMAGE_ID:${{ github.sha }} .
        docker push $IMAGE_ID:latest
        docker push $IMAGE_ID:${{ github.sha }}

    # 3. EC2에서 이미지 pull 및 실행
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST_PROD }}
        username: ec2-user
        key: ${{ secrets.SSH_KEY }}
        script: |
          # 이미지 이름 정의
          IMAGE_ID=ghcr.io/team-lms-2026-1/lms-frontend

          # GitHub Container Registry 로그인 (EC2에서도 필요)
          echo ${{ secrets.GITHUB_TOKEN }} | sudo docker login ghcr.io -u ${{ github.actor }} --password-stdin

          # 기존 컨테이너 정리
          sudo docker stop frontend-server || true
          sudo docker rm frontend-server || true
          sudo docker rmi $IMAGE_ID:latest || true

          # 이미지 pull
          sudo docker pull $IMAGE_ID:latest

          # 실행
          sudo docker run -d --name frontend-server \
            -p 3000:3000 \
            -e NEXT_PUBLIC_API_URL=http://43.201.157.8:8080 \
            -e API_BASE_URL=http://43.201.157.8:8080 \
            $IMAGE_ID:latest
          
          # 정리
          sudo docker image prune -f