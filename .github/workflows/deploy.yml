name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # ⚠️ 중요: gradlew 실행 권한 부여 (backend 폴더 진입)
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      working-directory: ./backend

    # ⚠️ 중요: 빌드 실행 (backend 폴더에서 실행)
    - name: Build with Gradle
      run: ./gradlew clean build -x test
      working-directory: ./backend

    # 빌드된 Jar 파일을 EC2로 전송
    - name: Copy Jar to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST_PROD }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        # 소스 경로도 backend/build/... 로 시작해야 함
        source: "backend/build/libs/app.jar"
        target: "/home/${{ secrets.USERNAME }}/app"
        strip_components: 3 # backend/build/libs/ 경로 떼고 파일만 전송

    # 6. EC2에 접속해서 서버 실행
    - name: Execute Server on EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST_PROD }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        timeout: 30m
        command_timeout: 30m
        script: |
            # 1. 기존에 떠있는 도커 컨테이너가 있다면 중지하고 삭제
            sudo docker stop backend-server || true
            sudo docker rm backend-server || true

            # 2. 도커로 서버 실행
            # --network host: 호스트 네트워크 사용 (포트 포워딩 불필요)
            sudo docker run -d --name backend-server \
              --network host \
              -v /home/${{ secrets.USERNAME }}/app/app.jar:/app.jar \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e RDS_ENDPOINT=${{ secrets.RDS_ENDPOINT }} \
              -e DB_USER=${{ secrets.DB_USER }} \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              openjdk:17-jdk-slim \
              java -Xms128m -Xmx128m -jar /app.jar
            
            # 3. 안 쓰는 찌꺼기 이미지 정리 (용량 확보)
            sudo docker image prune -f