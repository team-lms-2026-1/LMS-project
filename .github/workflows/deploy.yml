name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # ⚠️ 중요: gradlew 실행 권한 부여 (backend 폴더 진입)
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      working-directory: ./backend

    # ⚠️ 중요: 빌드 실행 (backend 폴더에서 실행)
    - name: Build with Gradle
      run: ./gradlew clean build -x test
      working-directory: ./backend

    # 빌드된 Jar 파일을 EC2로 전송
    - name: Copy Jar to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST_PROD }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        # 소스 경로도 backend/build/... 로 시작해야 함
        source: "backend/build/libs/*.jar"
        target: "/home/${{ secrets.USERNAME }}/app"
        strip_components: 3 # backend/build/libs/ 경로 떼고 파일만 전송

    # EC2에 접속해서 서버 실행
    - name: Execute Server on EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST_PROD }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        timeout: 30m
        command_timeout: 30m
        script: |
           # --- [1. 메모리 부족 해결: Swap 설정] ---
            # 1-1. Swap 파일이 없으면 생성 (지난번에 성공했으므로 이번엔 건너뜀)
            if [ ! -f /swapfile ]; then
              sudo dd if=/dev/zero of=/swapfile bs=128M count=16
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              echo '/swapfile swap swap defaults 0 0' | sudo tee -a /etc/fstab
            fi
            
            # 1-2. Swap 활성화 (중요: 파일이 있어도 스왑이 꺼져있을 수 있으므로 강제 활성화)
            sudo swapon /swapfile || true

            # --- [2. 기존 서버 종료] ---
            pgrep -f java | xargs -r kill -9
            sleep 5
            
            # --- [3. 배포 폴더로 이동] ---
            mkdir -p /home/${{ secrets.USERNAME }}/app
            cd /home/${{ secrets.USERNAME }}/app

            # --- [4. 서버 실행 (안전하게 400MB로 제한)] ---
            # t2.micro는 램이 1GB뿐이므로, OS 여유분을 위해 400MB로 줄입니다.
            nohup java -Xms400m -Xmx400m -jar \
              -Dspring.profiles.active=prod \
              -DRDS_ENDPOINT=${{ secrets.RDS_ENDPOINT }} \
              -DDB_USER=${{ secrets.DB_USER }} \
              -DDB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              *.jar > app.log 2>&1 < /dev/null &
            
            # 5. 확인 및 종료
            echo "Server started successfully."
            sleep 2
            exit 0